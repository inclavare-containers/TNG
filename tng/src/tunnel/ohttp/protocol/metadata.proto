syntax = "proto3";

package tng.ohttp.metadata;

// Metadata for encrypted requests, including client authentication method
// and optional hints for server key selection.
message Metadata {
  // Specifies the client authentication method used in this request.
  oneof client_auth {
    // No client authentication; the client is treated as anonymous.
    NoAuth no_auth = 1;

    // Client authenticates using a public key that has been attested by a trusted service.
    AttestedPublicKey attested_public_key = 2;
  }

  // Optional hint: provides a cryptographic identifier to help the server locate 
  // the correct key configuration for decryption.
  //
  // Although key_config contains an 'id' field (1-byte u8), it only allows 256 unique values,
  // which is insufficient for large-scale or dynamic deployments.
  // This SHA-256 hash offers a 32-byte globally unique identifier to avoid collisions.
  //
  // Servers SHOULD use this hint to select the appropriate key_config, if a matching one exists.
  // If not present, the server may fall back to other mechanisms (e.g., default key, ID-based lookup).
  ServerKeyConfigHint key_config_hint = 3;
}

// Indicates that no client authentication is performed.
// The client is considered anonymous.
message NoAuth {
  // Empty message as there are no additional fields
}

// Represents client authentication via a public key that has been attested (e.g., via Intel SGX, AMD SEV, etc.)
//
// This includes:
// - The attestation evidence (e.g., JWT token from attestation service)
// - The client's public key, used for key exchange or signing
message AttestedPublicKey {
  // The attestation result of the client, typically a JWT or CBOR token issued by an attestation service.
  // This proves that the client is running in a trusted execution environment (TEE).
  string attestation_result = 1;

  // The client(sender)'s public key, encoded in binary format
  // Used by the server to establish secure channel only.
  bytes pk_s = 2;
}

// Hint for the server to identify the key configuration needed to decrypt the request.
message ServerKeyConfigHint {
  // SHA-256 hash of the key_config, represented as exactly 32 bytes of binary data.
  //
  // This value MUST be the full SHA-256 digest in raw (not hex-encoded) format.
  //
  // Servers SHOULD attempt to match this digest against known key_config instances
  // to efficiently retrieve the correct decryption key material.
  bytes sha256 = 1;  // Must be exactly 32 bytes
}
