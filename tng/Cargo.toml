[package]
edition = "2021"
name = "tng"
version = "2.2.4"

[lib]
crate-type = ["cdylib", "rlib"]

[dependencies]
again = "0.1.2"
anyhow = "1.0.98"
async-stream = "0.3.6"
async-trait = "0.1.88"
async-tungstenite = {version = "0.25.1", optional = true}
auto_enums = {version = "0.8", features = ["std", "tokio1"]}
axum = {version = "0.8.4", optional = true}# to disable mio
bytes = "1.10.1"
cidr = {version = "0.2.3", features = ["serde"]}
clap = {version = "4.5.39", features = ["derive"]}
console-subscriber = {version = "0.4.1", optional = true}
const_format = "0.2.34"
derivative = "2.2.0"
either = "1.15.0"
fast-socks5 = {git = "https://github.com/dizda/fast-socks5.git", rev = "4c8985c", optional = true}
flume = {version = "0.11.1", features = ["async"]}
futures = "0.3.31"
getrandom = {version = "0.3"}
h2 = {version = "0.4.10", features = ["stream"]}
hex = "0.4.3"
http = "1.3.1"
http-body = "1.0.1"
http-body-util = "0.1.3"
httparse = "1.10.1"
hyper = {version = "1", default-features = false, features = ["http1", "http2"]}
hyper-util = {workspace = true}
indexmap = {version = "2.9.0", features = ["serde"]}
itertools = "0.14.0"
nix = {version = "0.29.0", features = ["process", "signal", "socket", "net"]}
once_cell = "1.21.3"
opentelemetry = {version = "0.29.1", optional = true}
opentelemetry-otlp = {version = "0.29.0", optional = true, default-features = false, features = [
  "logs",
  "metrics",
  "grpc-tonic",
  "gzip-tonic",
  "tls-webpki-roots",
  "reqwest-client",
  "http-proto",
  "http-json",
  "reqwest-rustls-webpki-roots",
]}
opentelemetry-stdout = {version = "0.29.0", optional = true}
opentelemetry_sdk = {version = "0.29.0", optional = true, features = [
  "experimental_async_runtime",
  "experimental_metrics_periodicreader_with_async_runtime",
  "experimental_logs_batch_log_processor_with_async_runtime",
  "experimental_trace_batch_span_processor_with_async_runtime",
  "rt-tokio",
]}
pin-project = "1"
pin-project-lite = "0.2.16"
portpicker = {version = "0.1.1", optional = true}# to disable mio
rand = "0.9.1"
rats-cert = {path = "../deps/rats-rs/rats-cert", default-features = false, features = ["crypto-rustcrypto"]}
regex = "1.11.1"
reqwest = {workspace = true, optional = true}
ring = {version = "0.17.11", features = ["wasm32_unknown_unknown_js"], optional = true}
rustls = {version = "0.23.27", default-features = false, features = ["logging", "std", "tls12", "ring", "brotli"]}
rustls-pemfile = "2.2.0"
rustls-pki-types = {version = "*", optional = true}
scopeguard = "1.2.0"
serde = {version = "1.0", features = ["derive"]}
serde_json = "1.0.140"
serde_variant = "0.1.3"
serde_with = {version = "3.12.0", features = ["json"]}
shadow-rs = {version = "=1.0.0", default-features = false}
socket2 = {version = "0.5.10", optional = true}
strum = "0.27.1"
strum_macros = "0.27.1"
tempfile = "3.20.0"
tokio = {workspace = true}
tokio-graceful = {workspace = true}
tokio-rustls = {version = "0.26.2", default-features = false, features = ["logging", "tls12", "ring"]}
tokio-util = {version = "0.7.15", features = ["compat"]}
tokio_with_wasm = {version = "=0.8.2", features = ["rt", "macros", "time"]}
tonic = {version = "0.12.3", optional = true}
tower = {version = "0.5", features = ["util"]}
tower-http = {version = "0.6.6", features = ["trace", "set-header"]}
tracing = "0.1"
tracing-futures = {version = "0.2.5", features = ["futures-03"]}
tracing-opentelemetry = {version = "0.30.0", optional = true}
tracing-subscriber = {version = "0.3", features = ["env-filter"]}
wasm-bindgen-futures = {version = "0.4.50", optional = true}
which = {version = "7.0.3", optional = true}
ws_stream_tungstenite = {version = "0.13.0", optional = true}
ws_stream_wasm = {version = "=0.7.4", optional = true}

[build-dependencies]
shadow-rs = {version = "=1.0.0", default-features = false, features = ["tzdb", "build"]}

[dev-dependencies]
ctor = "=0.4.1"
hyper = {version = "1", default-features = false, features = ["http1", "http2", "client", "server"]}
portpicker = "0.1.1"

[features]
default = [
  "tokio-console",
  "metric",
  "trace",
  "ingress-http-proxy",
  "ingress-mapping",
  "ingress-netfilter",
  "ingress-socks5",
  "egress-mapping",
  "egress-netfilter",
  "unix",
]
egress = ["dep:axum", "hyper/server", "dep:async-tungstenite"]
egress-mapping = ["egress"]
egress-netfilter = ["egress", "dep:which"]
ingress = ["dep:async-tungstenite"]
ingress-http-proxy = ["ingress", "hyper/client"]
ingress-mapping = ["ingress"]
ingress-netfilter = ["ingress", "dep:portpicker", "dep:which"]
ingress-socks5 = ["ingress", "dep:fast-socks5"]
metric = ["dep:tonic", "dep:opentelemetry", "dep:opentelemetry-otlp", "dep:opentelemetry-stdout", "dep:opentelemetry_sdk", "dep:tracing-opentelemetry"]
tokio-console = ["dep:console-subscriber", "tokio/tracing"]
trace = [
  "dep:tonic",
  "dep:opentelemetry",
  "dep:opentelemetry-otlp",
  "dep:opentelemetry-stdout",
  "dep:opentelemetry_sdk",
  "dep:tracing-opentelemetry",
  "dep:reqwest",
]
unix = [
  "rats-cert/unix",
  "dep:socket2",
  "dep:reqwest",
  "tokio/rt-multi-thread",
  "tokio/time",
  "rats-cert/attester-coco",
  "rats-cert/verifier-coco",
  "dep:ws_stream_tungstenite",
  "async-tungstenite/tokio-runtime",
]
wasm = [
  "rats-cert/wasm",
  "rats-cert/verifier-coco",
  "rustls-pki-types/web",
  "dep:ring",
  "dep:reqwest",
  "dep:ws_stream_wasm",
  "dep:wasm-bindgen-futures",
]
